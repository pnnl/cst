# . $HOME/venv/bin/activate

pushd . > '/dev/null';
SCRIPT_PATH="${BASH_SOURCE[0]:-$0}";

while [ -h "$SCRIPT_PATH" ];
do
    cd "$( dirname -- "$SCRIPT_PATH"; )";
    SCRIPT_PATH="$( readlink -f -- "$SCRIPT_PATH"; )";
done

cd "$( dirname -- "$SCRIPT_PATH"; )" > '/dev/null';
SCRIPT_PATH="$( pwd; )";
popd  > '/dev/null';

# Directory
export COSIM_DIR=$SCRIPT_PATH
export REPO_DIR=$HOME/repository
export BUILD_DIR=$COSIM_DIR/scripts/builder
export STACK_DIR=$COSIM_DIR/scripts/workflow
export COSIM_USER=worker
export COSIM_HOME=/home/$COSIM_USER
export COSIM_HOST=$(cat /etc/hostname)
export POSTGRES_HOST=database
export POSTGRES_DB=copper
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=postgres
export POSTGRES_PORT=5432
export PG_TEST_DB=test
export PG_TEST_USER=postgres
export PG_TEST_PWD=postgres
export PG_TEST_PORT=5432

export PGADMIN_DEFAULT_EMAIL=user@domain.com
export PGADMIN_DEFAULT_PASSWORD=SuperSecret

# Airflow
# add user id for linux
export AIRFLOW_UID=$(id -u)
# add user id for windows
# export AIRFLOW_UID=50000
export AIRFLOW_GID=0
export AIRFLOW_PROJ_DIR=$COSIM_DIR/run
# export _AIRFLOW_WWW_USER_USERNAME=
# export _AIRFLOW_WWW_USER_PASSWORD=

envsubst < env_python.Dockerfile > python.Dockerfile

cat > $COSIM_DIR/scripts/docker/.env << EOF
ENV COSIM_DIR=$SCRIPT_PATH
ENV STACK_DIR=$COSIM_DIR/scripts/workflow
ENV RUNFLOW=$COSIM_DIR/run

# Database
ENV COSIM_HOST=$(cat /etc/hostname)
ENV POSTGRES_HOST=database
ENV POSTGRES_DB=copper
ENV POSTGRES_USER=postgres
ENV POSTGRES_PWD=postgres
ENV POSTGRES_PORT=5432
ENV PG_TEST_DB=test
ENV PG_TEST_USER=postgres
ENV PG_TEST_PWD=postgres
ENV PG_TEST_PORT=5432
EOF

# if building without docker, add 'export' to environment
#export TESPDIR=$HOME/tesp
#export MESPDIR=$HOME/mesp
#export INSTDIR=$HOME/tenv

# COMPILE exports
JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
PYHELICS_INSTALL=$INSTDIR
GLPATH=$INSTDIR/lib/gridlabd:$INSTDIR/share/gridlabd
CPLUS_INCLUDE_PATH=/usr/include/hdf5/serial:$INSTDIR/include
FNCS_INCLUDE_DIR=$INSTDIR/include
FNCS_LIBRARY=$INSTDIR/lib
LD_LIBRARY_PATH=$INSTDIR/lib
LD_RUN_PATH=$INSTDIR/lib

# PATH
PATH=$INSTDIR/bin:$PATH
PATH=$JAVA_HOME:$PATH
PATH=$PATH:$INSTDIR/energyplus
PATH=$PATH:$INSTDIR/energyplus/PreProcess
PATH=$PATH:$INSTDIR/energyplus/PostProcess

# PSST environment variables
PSST_SOLVER=ipopt
# PSST_SOLVER=$INSTDIR/ibm/cplex/bin/x86-64_linux/cplexamp
# 'PSST_SOLVER path' -- one of "cbc", "ipopt", "$INSTDIR/ibm/cplex/bin/x86-64_linux/cplexamp"
PSST_WARNING=ignore
# 'PSST_WARNING action' -- one of "error", "ignore", "always", "default", "module", or "once"

# PROXY export if needed
# export HTTPS_PROXY=http://proxy01.pnl.gov:3128
